<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WhatsApp Clone</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
</head>
<body>
    <h1>WhatsApp Clone</h1>
    <div id="login">
        <h2>Login</h2>
        <input type="text" id="username"  placeholder="Username" />
        <input type="password" id="password"  placeholder="Password" />
        <button onclick="login()">Login</button>
    </div>

    <div id="chat" style="display:none;">
        <h2>Chat</h2>
        <label for="users">Select User:</label>
        <select onchange="selectasd()" id="users"></select>
        

        <div id="messages" style="border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: scroll;">
            <!-- Mesajlar buraya eklenecek -->
        </div>
        <input style="width:100%;" type="text" id="message" placeholder="Type a message" />
        <button onclick="sendMessage()">Send</button>
    </div>

    <script>
        document.getElementById("message").addEventListener("keydown", function(event) {
            if (event.key === "Enter") {
                sendMessage(); // Enter tuşuna basıldığında mesajı gönder
                event.preventDefault(); // Formun submit edilmesini engelle
            }
        });
        let token = '';
        userId = 0
        let connection = null;

        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            const response = await fetch('/api/UserAuth/login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ username, password })
            });

            if (response.ok) {
                const data = await response.json();
                token = data.token;
                var asd = parseJwt(token)
                userId = asd.sub
                document.getElementById('login').style.display = 'none';
                document.getElementById('chat').style.display = 'block';
                startConnection();
                loadUsers();
            } else {
                const error = await response.json();
                alert('Login failed: ' + (error.message || 'Unknown error'));
            }
        }
        function parseJwt(token) {
            // Token'ı parçala
            const base64Url = token.split('.')[1]; // Payload kısmı
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/'); // Base64 URL kodlamasını düzelt

            const jsonPayload = decodeURIComponent(escape(atob(base64))); // Base64'ten JSON'a dönüştür
            return JSON.parse(jsonPayload); // JSON'ı objeye dönüştür
        }

        function startConnection() {
            connection = new signalR.HubConnectionBuilder()
                .withUrl('/chathub', { accessTokenFactory: () => token })
                .build();

            connection.on('ReceiveMessage', (message) => {
                const receiverId = document.getElementById('users').value;
                if(message.senderId == receiverId) {
                    const msgDiv = document.getElementById('messages');
                    msgDiv.innerHTML += `<p style="text-align:left" > <em style="color:blue" >${new Date(message.timestamp).toLocaleTimeString()}</em>  ${message.content.content} </p>`;
                    msgDiv.scrollTop = msgDiv.scrollHeight; // Otomatik olarak en son mesaja kaydır
                }
                
            });

            connection.start()
                .then(() => console.log('SignalR connected'))
                .catch(err => console.error('SignalR connection error: ', err));
        }

        async function loadUsers() {
            const response = await fetch('/api/UserAuth/users', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                const users = await response.json();
                const usersSelect = document.getElementById('users');
                usersSelect.innerHTML = ''; // Önceki seçenekleri temizle

                users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.text = user.username; // veya user.email
                    usersSelect.add(option);
                });
                loadMessages(userId,users[0].id)
            } else {
                const error = await response.json();
                alert('Failed to load users: ' + (error.message || 'Unknown error'));
            }
        }
        async function selectasd() {
            const receiverId = document.getElementById('users').value;
            loadMessages(userId,receiverId)
        }
        async function loadMessages(senderId, receiverId) {
            const response = await fetch('/api/message/GetMyMessages/' + senderId + '/' + receiverId, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            if (response.ok) {
                const users = await response.json();
                const msgDiv = document.getElementById('messages');
                msgDiv.innerHTML = "";
                users.forEach(msg => {
                    if(msg.senderId == userId )
                        msgDiv.innerHTML += `<p style="text-align:right" > ${msg.content} <em  style="color:blue">${new Date(msg.timestamp).toLocaleTimeString()}</em></p>`;
                    else
                        msgDiv.innerHTML += `<p style="text-align:left" > <em  style="color:blue" >${new Date(msg.timestamp).toLocaleTimeString()}</em> ${msg.content} </p>`;
                    msgDiv.scrollTop = msgDiv.scrollHeight; // Otomatik olarak en son mesaja kaydır
                });
            } else {
                const error = await response.json();
                alert('Failed to load users: ' + (error.message || 'Unknown error'));
            }
        }

        async function sendMessage() {
            const receiverId = document.getElementById('users').value;
            const message = document.getElementById('message').value.trim();

            if (connection && message !== '') {
                try {
                    var asd = {
                        SenderId:parseInt(userId),
                        ReceiverId:parseInt(receiverId) ,
                        Content:message,
                        Timestamp:new Date()
                    }
                    await connection.invoke('SendMessage', asd);
                    const msgDiv = document.getElementById('messages');
                    msgDiv.innerHTML += `<p style="text-align:right" > ${message} <em  style="color:blue;" >${new Date().toLocaleTimeString()}</em></p>`;
                    msgDiv.scrollTop = msgDiv.scrollHeight; // Otomatik olarak en son mesaja kaydır
                    document.getElementById('message').value = '';
                } catch (err) {
                    console.error('SendMessage error: ', err);
                }
            }
        }
    </script>
</body>
</html>
